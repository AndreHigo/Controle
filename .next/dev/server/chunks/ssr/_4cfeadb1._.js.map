{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/05585611100/Videos/CtrlGastos/Controle/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\nexport async function createClient() {\r\n  const cookieStore = await cookies()\r\n\r\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\r\n    cookies: {\r\n      getAll() {\r\n        return cookieStore.getAll()\r\n      },\r\n      setAll(cookiesToSet) {\r\n        try {\r\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\r\n        } catch {\r\n          // The \"setAll\" method was called from a Server Component.\r\n          // This can be ignored if you have proxy refreshing user sessions.\r\n        }\r\n      },\r\n    },\r\n  })\r\n}\r\n\r\nexport { createClient as createServerClient }\r\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,yQAAO;IAEjC,OAAO,IAAA,4SAAkB,sUAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,kEAAkE;gBACpE;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 38, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/05585611100/Videos/CtrlGastos/Controle/app/credit-cards/%5Bid%5D/purchases/actions.ts"],"sourcesContent":["\"use server\"\n\nimport { createServerClient } from \"@/lib/supabase/server\"\nimport { revalidatePath } from \"next/cache\"\nimport { redirect } from \"next/navigation\"\n\n// Função para calcular a data de fechamento da fatura com base na data da compra\nfunction calculateInvoiceDate(purchaseDate: Date, closingDay: number, dueDay: number) {\n  const purchase = new Date(purchaseDate)\n  const year = purchase.getFullYear()\n  const month = purchase.getMonth()\n  const day = purchase.getDate()\n\n  // Se a compra foi feita antes do dia de fechamento, vai para a fatura deste mês\n  // Se foi depois, vai para a fatura do mês seguinte\n  let closingDate: Date\n  let dueDate: Date\n\n  if (day <= closingDay) {\n    // Fatura fecha neste mês\n    closingDate = new Date(year, month, closingDay)\n    dueDate = new Date(year, month, dueDay)\n  } else {\n    // Fatura fecha no próximo mês\n    closingDate = new Date(year, month + 1, closingDay)\n    dueDate = new Date(year, month + 1, dueDay)\n  }\n\n  // Se o dia de vencimento for menor que o dia de fechamento, o vencimento é no mês seguinte\n  if (dueDay < closingDay) {\n    dueDate = new Date(dueDate.getFullYear(), dueDate.getMonth() + 1, dueDay)\n  }\n\n  return { closingDate, dueDate }\n}\n\n// Função para buscar ou criar a fatura\nasync function getOrCreateInvoice(supabase: any, cardId: string, userId: string, closingDate: Date, dueDate: Date) {\n  const referenceMonth = closingDate.getMonth() + 1\n  const referenceYear = closingDate.getFullYear()\n\n  const { data: existingInvoice } = await supabase\n    .from(\"credit_card_invoices\")\n    .select(\"*\")\n    .eq(\"credit_card_id\", cardId)\n    .eq(\"user_id\", userId)\n    .eq(\"reference_month\", referenceMonth)\n    .eq(\"reference_year\", referenceYear)\n    .eq(\"status\", \"open\")\n    .single()\n\n  if (existingInvoice) {\n    return existingInvoice.id\n  }\n\n  const { data: newInvoice, error } = await supabase\n    .from(\"credit_card_invoices\")\n    .insert({\n      user_id: userId,\n      credit_card_id: cardId,\n      reference_month: referenceMonth,\n      reference_year: referenceYear,\n      closing_date: closingDate.toISOString().split(\"T\")[0],\n      due_date: dueDate.toISOString().split(\"T\")[0],\n      status: \"open\",\n      total_amount: 0,\n    })\n    .select()\n    .single()\n\n  if (error) {\n    throw new Error(error.message)\n  }\n\n  return newInvoice.id\n}\n\nexport async function createPurchase(cardId: string, formData: FormData) {\n  const supabase = await createServerClient()\n  const {\n    data: { user },\n  } = await supabase.auth.getUser()\n\n  if (!user) {\n    redirect(\"/auth/login\")\n  }\n\n  const { data: card } = await supabase\n    .from(\"credit_cards\")\n    .select(\"*\")\n    .eq(\"id\", cardId)\n    .eq(\"user_id\", user.id)\n    .single()\n\n  if (!card) {\n    throw new Error(\"Cartão não encontrado\")\n  }\n\n  const description = formData.get(\"description\") as string\n  const amount = Number.parseFloat(formData.get(\"amount\") as string)\n  const purchaseDate = new Date(formData.get(\"purchase_date\") as string)\n  const categoryId = formData.get(\"category_id\") as string | null\n  const installments = Number.parseInt(formData.get(\"installments\") as string)\n  const notes = formData.get(\"notes\") as string\n  const paymentMethod = (formData.get(\"payment_method\") as string) || \"credit\"\n\n  if (paymentMethod === \"credit\") {\n    const totalAmount = amount\n    const { data: validation } = await supabase.rpc(\"validate_credit_limit\", {\n      p_card_id: cardId,\n      p_new_purchase_amount: totalAmount,\n    })\n\n    if (validation && !validation.valid) {\n      throw new Error(validation.error || \"Limite de crédito insuficiente\")\n    }\n  }\n\n  const { closingDate, dueDate } = calculateInvoiceDate(purchaseDate, card.closing_day, card.due_day)\n  const invoiceId = await getOrCreateInvoice(supabase, cardId, user.id, closingDate, dueDate)\n\n  if (installments > 1) {\n    const installmentAmount = amount / installments\n    const purchases = []\n\n    for (let i = 0; i < installments; i++) {\n      const installmentDate = new Date(purchaseDate)\n      installmentDate.setMonth(installmentDate.getMonth() + i)\n\n      const { closingDate: instClosingDate, dueDate: instDueDate } = calculateInvoiceDate(\n        installmentDate,\n        card.closing_day,\n        card.due_day,\n      )\n\n      const instInvoiceId = await getOrCreateInvoice(supabase, cardId, user.id, instClosingDate, instDueDate)\n\n      purchases.push({\n        user_id: user.id,\n        credit_card_id: cardId,\n        invoice_id: instInvoiceId,\n        description: `${description} (${i + 1}/${installments})`,\n        amount: installmentAmount,\n        purchase_date: installmentDate.toISOString().split(\"T\")[0],\n        category_id: categoryId || null,\n        installments,\n        installment_number: i + 1,\n        notes: notes || null,\n        payment_method: paymentMethod,\n      })\n    }\n\n    const { error } = await supabase.from(\"credit_card_purchases\").insert(purchases)\n\n    if (error) {\n      throw new Error(error.message)\n    }\n  } else {\n    const { error } = await supabase.from(\"credit_card_purchases\").insert({\n      user_id: user.id,\n      credit_card_id: cardId,\n      invoice_id: invoiceId,\n      description,\n      amount,\n      purchase_date: purchaseDate.toISOString().split(\"T\")[0],\n      category_id: categoryId || null,\n      installments: 1,\n      installment_number: 1,\n      notes: notes || null,\n      payment_method: paymentMethod,\n    })\n\n    if (error) {\n      throw new Error(error.message)\n    }\n  }\n\n  revalidatePath(`/credit-cards/${cardId}/purchases`)\n  redirect(`/credit-cards/${cardId}/purchases`)\n}\n\nexport async function updatePurchase(id: string, cardId: string, formData: FormData) {\n  const supabase = await createServerClient()\n  const {\n    data: { user },\n  } = await supabase.auth.getUser()\n\n  if (!user) {\n    redirect(\"/auth/login\")\n  }\n\n  const description = formData.get(\"description\") as string\n  const amount = Number.parseFloat(formData.get(\"amount\") as string)\n  const purchaseDate = formData.get(\"purchase_date\") as string\n  const categoryId = formData.get(\"category_id\") as string | null\n  const notes = formData.get(\"notes\") as string\n\n  const { error } = await supabase\n    .from(\"credit_card_purchases\")\n    .update({\n      description,\n      amount,\n      purchase_date: purchaseDate,\n      category_id: categoryId || null,\n      notes: notes || null,\n    })\n    .eq(\"id\", id)\n    .eq(\"user_id\", user.id)\n\n  if (error) {\n    throw new Error(error.message)\n  }\n\n  revalidatePath(`/credit-cards/${cardId}/purchases`)\n  redirect(`/credit-cards/${cardId}/purchases`)\n}\n\nexport async function deletePurchase(id: string, cardId: string) {\n  const supabase = await createServerClient()\n  const {\n    data: { user },\n  } = await supabase.auth.getUser()\n\n  if (!user) {\n    return\n  }\n\n  await supabase\n    .from(\"credit_card_purchases\")\n    .delete()\n    .eq(\"id\", id)\n    .eq(\"user_id\", user.id)\n\n  revalidatePath(`/credit-cards/${cardId}/purchases`)\n}\n"],"names":[],"mappings":";;;;;;;;;AAEA;AACA;AACA;AAAA;;;;;;AAEA,iFAAiF;AACjF,SAAS,qBAAqB,YAAkB,EAAE,UAAkB,EAAE,MAAc;IAClF,MAAM,WAAW,IAAI,KAAK;IAC1B,MAAM,OAAO,SAAS,WAAW;IACjC,MAAM,QAAQ,SAAS,QAAQ;IAC/B,MAAM,MAAM,SAAS,OAAO;IAE5B,gFAAgF;IAChF,mDAAmD;IACnD,IAAI;IACJ,IAAI;IAEJ,IAAI,OAAO,YAAY;QACrB,yBAAyB;QACzB,cAAc,IAAI,KAAK,MAAM,OAAO;QACpC,UAAU,IAAI,KAAK,MAAM,OAAO;IAClC,OAAO;QACL,8BAA8B;QAC9B,cAAc,IAAI,KAAK,MAAM,QAAQ,GAAG;QACxC,UAAU,IAAI,KAAK,MAAM,QAAQ,GAAG;IACtC;IAEA,2FAA2F;IAC3F,IAAI,SAAS,YAAY;QACvB,UAAU,IAAI,KAAK,QAAQ,WAAW,IAAI,QAAQ,QAAQ,KAAK,GAAG;IACpE;IAEA,OAAO;QAAE;QAAa;IAAQ;AAChC;AAEA,uCAAuC;AACvC,eAAe,mBAAmB,QAAa,EAAE,MAAc,EAAE,MAAc,EAAE,WAAiB,EAAE,OAAa;IAC/G,MAAM,iBAAiB,YAAY,QAAQ,KAAK;IAChD,MAAM,gBAAgB,YAAY,WAAW;IAE7C,MAAM,EAAE,MAAM,eAAe,EAAE,GAAG,MAAM,SACrC,IAAI,CAAC,wBACL,MAAM,CAAC,KACP,EAAE,CAAC,kBAAkB,QACrB,EAAE,CAAC,WAAW,QACd,EAAE,CAAC,mBAAmB,gBACtB,EAAE,CAAC,kBAAkB,eACrB,EAAE,CAAC,UAAU,QACb,MAAM;IAET,IAAI,iBAAiB;QACnB,OAAO,gBAAgB,EAAE;IAC3B;IAEA,MAAM,EAAE,MAAM,UAAU,EAAE,KAAK,EAAE,GAAG,MAAM,SACvC,IAAI,CAAC,wBACL,MAAM,CAAC;QACN,SAAS;QACT,gBAAgB;QAChB,iBAAiB;QACjB,gBAAgB;QAChB,cAAc,YAAY,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QACrD,UAAU,QAAQ,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QAC7C,QAAQ;QACR,cAAc;IAChB,GACC,MAAM,GACN,MAAM;IAET,IAAI,OAAO;QACT,MAAM,IAAI,MAAM,MAAM,OAAO;IAC/B;IAEA,OAAO,WAAW,EAAE;AACtB;AAEO,eAAe,eAAe,MAAc,EAAE,QAAkB;IACrE,MAAM,WAAW,MAAM,IAAA,+IAAkB;IACzC,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAE/B,IAAI,CAAC,MAAM;QACT,IAAA,gUAAQ,EAAC;IACX;IAEA,MAAM,EAAE,MAAM,IAAI,EAAE,GAAG,MAAM,SAC1B,IAAI,CAAC,gBACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,QACT,EAAE,CAAC,WAAW,KAAK,EAAE,EACrB,MAAM;IAET,IAAI,CAAC,MAAM;QACT,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,cAAc,SAAS,GAAG,CAAC;IACjC,MAAM,SAAS,OAAO,UAAU,CAAC,SAAS,GAAG,CAAC;IAC9C,MAAM,eAAe,IAAI,KAAK,SAAS,GAAG,CAAC;IAC3C,MAAM,aAAa,SAAS,GAAG,CAAC;IAChC,MAAM,eAAe,OAAO,QAAQ,CAAC,SAAS,GAAG,CAAC;IAClD,MAAM,QAAQ,SAAS,GAAG,CAAC;IAC3B,MAAM,gBAAgB,AAAC,SAAS,GAAG,CAAC,qBAAgC;IAEpE,IAAI,kBAAkB,UAAU;QAC9B,MAAM,cAAc;QACpB,MAAM,EAAE,MAAM,UAAU,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,yBAAyB;YACvE,WAAW;YACX,uBAAuB;QACzB;QAEA,IAAI,cAAc,CAAC,WAAW,KAAK,EAAE;YACnC,MAAM,IAAI,MAAM,WAAW,KAAK,IAAI;QACtC;IACF;IAEA,MAAM,EAAE,WAAW,EAAE,OAAO,EAAE,GAAG,qBAAqB,cAAc,KAAK,WAAW,EAAE,KAAK,OAAO;IAClG,MAAM,YAAY,MAAM,mBAAmB,UAAU,QAAQ,KAAK,EAAE,EAAE,aAAa;IAEnF,IAAI,eAAe,GAAG;QACpB,MAAM,oBAAoB,SAAS;QACnC,MAAM,YAAY,EAAE;QAEpB,IAAK,IAAI,IAAI,GAAG,IAAI,cAAc,IAAK;YACrC,MAAM,kBAAkB,IAAI,KAAK;YACjC,gBAAgB,QAAQ,CAAC,gBAAgB,QAAQ,KAAK;YAEtD,MAAM,EAAE,aAAa,eAAe,EAAE,SAAS,WAAW,EAAE,GAAG,qBAC7D,iBACA,KAAK,WAAW,EAChB,KAAK,OAAO;YAGd,MAAM,gBAAgB,MAAM,mBAAmB,UAAU,QAAQ,KAAK,EAAE,EAAE,iBAAiB;YAE3F,UAAU,IAAI,CAAC;gBACb,SAAS,KAAK,EAAE;gBAChB,gBAAgB;gBAChB,YAAY;gBACZ,aAAa,GAAG,YAAY,EAAE,EAAE,IAAI,EAAE,CAAC,EAAE,aAAa,CAAC,CAAC;gBACxD,QAAQ;gBACR,eAAe,gBAAgB,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;gBAC1D,aAAa,cAAc;gBAC3B;gBACA,oBAAoB,IAAI;gBACxB,OAAO,SAAS;gBAChB,gBAAgB;YAClB;QACF;QAEA,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,yBAAyB,MAAM,CAAC;QAEtE,IAAI,OAAO;YACT,MAAM,IAAI,MAAM,MAAM,OAAO;QAC/B;IACF,OAAO;QACL,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,yBAAyB,MAAM,CAAC;YACpE,SAAS,KAAK,EAAE;YAChB,gBAAgB;YAChB,YAAY;YACZ;YACA;YACA,eAAe,aAAa,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;YACvD,aAAa,cAAc;YAC3B,cAAc;YACd,oBAAoB;YACpB,OAAO,SAAS;YAChB,gBAAgB;QAClB;QAEA,IAAI,OAAO;YACT,MAAM,IAAI,MAAM,MAAM,OAAO;QAC/B;IACF;IAEA,IAAA,8QAAc,EAAC,CAAC,cAAc,EAAE,OAAO,UAAU,CAAC;IAClD,IAAA,gUAAQ,EAAC,CAAC,cAAc,EAAE,OAAO,UAAU,CAAC;AAC9C;AAEO,eAAe,eAAe,EAAU,EAAE,MAAc,EAAE,QAAkB;IACjF,MAAM,WAAW,MAAM,IAAA,+IAAkB;IACzC,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAE/B,IAAI,CAAC,MAAM;QACT,IAAA,gUAAQ,EAAC;IACX;IAEA,MAAM,cAAc,SAAS,GAAG,CAAC;IACjC,MAAM,SAAS,OAAO,UAAU,CAAC,SAAS,GAAG,CAAC;IAC9C,MAAM,eAAe,SAAS,GAAG,CAAC;IAClC,MAAM,aAAa,SAAS,GAAG,CAAC;IAChC,MAAM,QAAQ,SAAS,GAAG,CAAC;IAE3B,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,yBACL,MAAM,CAAC;QACN;QACA;QACA,eAAe;QACf,aAAa,cAAc;QAC3B,OAAO,SAAS;IAClB,GACC,EAAE,CAAC,MAAM,IACT,EAAE,CAAC,WAAW,KAAK,EAAE;IAExB,IAAI,OAAO;QACT,MAAM,IAAI,MAAM,MAAM,OAAO;IAC/B;IAEA,IAAA,8QAAc,EAAC,CAAC,cAAc,EAAE,OAAO,UAAU,CAAC;IAClD,IAAA,gUAAQ,EAAC,CAAC,cAAc,EAAE,OAAO,UAAU,CAAC;AAC9C;AAEO,eAAe,eAAe,EAAU,EAAE,MAAc;IAC7D,MAAM,WAAW,MAAM,IAAA,+IAAkB;IACzC,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAE/B,IAAI,CAAC,MAAM;QACT;IACF;IAEA,MAAM,SACH,IAAI,CAAC,yBACL,MAAM,GACN,EAAE,CAAC,MAAM,IACT,EAAE,CAAC,WAAW,KAAK,EAAE;IAExB,IAAA,8QAAc,EAAC,CAAC,cAAc,EAAE,OAAO,UAAU,CAAC;AACpD;;;IA7JsB;IAwGA;IAoCA;;AA5IA,8WAAA;AAwGA,8WAAA;AAoCA,8WAAA"}},
    {"offset": {"line": 229, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/05585611100/Videos/CtrlGastos/Controle/.next-internal/server/app/credit-cards/%5Bid%5D/purchases/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {deletePurchase as '60be364629ba959bab73aa286202e159b30424cc04'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}